<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>鹿港景點計時地圖</title>

<style>
  html, body { height: 100%; margin: 0; padding: 0; }

  #app {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* 上方 UI（不覆蓋地圖） */
  #uiBar {
    flex: 0 0 auto;
    padding: 10px 12px;
    background: rgba(255,255,255,0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    z-index: 1;
  }

  #uiBar .title {
    font-weight: 700;
    font-size: 16px;
    margin-right: 6px;
  }

  #timerBox {
    font-weight: 700;
    font-size: 16px;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(245,245,245,1);
  }

  #statusBox {
    font-size: 14px;
    color: #333;
  }

  #uiBar button {
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }

  .start-btn { background: #2e7d32; color: #fff; }
  .cancel-btn { background: #e0e0e0; }
  .reset-btn { background: #1565c0; color: #fff; }

  #map {
    flex: 1 1 auto;
    width: 100%;
  }
</style>

<!-- 注意：加上 libraries=geometry 才能用 computeOffset -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE&libraries=geometry"></script>
</head>

<body>
<div id="app">
  <div id="uiBar">
    <div class="title">定位與計時</div>

    <button class="start-btn" id="btnStart" onclick="startGeolocation()">啟用定位</button>
    <button class="cancel-btn" id="btnSkip" onclick="skipGeolocation()">不啟用</button>
    <button class="reset-btn" onclick="recenterToLukang()">回到鹿港</button>

    <div id="timerBox">已花費時間：<span id="timer">00:00:00</span></div>
    <div id="statusBox">狀態：尚未選擇定位模式</div>
  </div>

  <div id="map"></div>
</div>

<script>
/* ===== 鹿港中心與範圍（進入後才開始計時）===== */
const LUKANG_CENTER = { lat: 24.056348, lng: 120.432589 }; // 鹿港老街附近
const LUKANG_RADIUS_M = 900; // 你要的「鹿港範圍」半徑（公尺）。可調：500/800/1200...

/* ===== 景點資料 ===== */
const locations = [
  { name: "玻璃館", lat: 24.068667, lng: 120.395437 },
  { name: "鹿港老街", lat: 24.056348, lng: 120.432589 },
  { name: "鹿港龍山寺", lat: 24.0504, lng: 120.4349 },
  { name: "鹿港天后宮", lat: 24.059338, lng: 120.431380 },
  { name: "玻璃媽祖廟", lat: 24.069118, lng: 120.394715 },
  { name: "桂花巷藝術村", lat: 24.055848, lng: 120.431928 },
  { name: "臺灣玻璃館", lat: 24.068970, lng: 120.394912 },
  { name: "鹿港民俗文物館", lat: 24.054200, lng: 120.436306 },
  { name: "九曲巷", lat: 24.0535, lng: 120.4350 },
  { name: "十宜樓", lat: 24.0535, lng: 120.4353 },
  { name: "鹿港意樓", lat: 24.0529, lng: 120.4353 },
  { name: "摸乳巷", lat: 24.051817, lng: 120.432231 }
];

let map;
let spotlightPolygon = null; // 「台灣變暗 + 鹿港挖洞」
let userMarker = null;
let watchId = null;

let startTime = null;
let timerInterval = null;
let geofenceEntered = false; // 進入鹿港範圍後才 true
let remainingLocations = new Set(locations.map(loc => loc.name));

function setStatus(msg) {
  document.getElementById("statusBox").textContent = "狀態：" + msg;
}

/* ===== 建立「挖洞」：外圈(大矩形) + 內圈(鹿港圓洞) ===== */
function buildSpotlightPolygon() {
  // 外圈：用大矩形包住台灣附近（不要用全世界，避免你說的「整個台灣都暗到怪」）
  // 這個範圍你也可再微調
  const outer = [
    { lat: 27.8, lng: 117.5 },
    { lat: 27.8, lng: 124.8 },
    { lat: 20.0, lng: 124.8 },
    { lat: 20.0, lng: 117.5 }
  ];

  // 內圈（洞）：用 geometry 計算圓周點
  const hole = makeCirclePath(LUKANG_CENTER, LUKANG_RADIUS_M, 90);

  spotlightPolygon = new google.maps.Polygon({
    map,
    paths: [outer, hole],  // 第一個是外圈，第二個是洞
    strokeOpacity: 0,
    fillOpacity: 0.40,     // 變暗程度（0~1）
    clickable: false
  });
}

/* 產生圓形路徑點（洞） */
function makeCirclePath(center, radiusMeters, points) {
  const path = [];
  for (let i = 0; i < points; i++) {
    const angle = (360 * i) / points;
    const p = google.maps.geometry.spherical.computeOffset(
      new google.maps.LatLng(center.lat, center.lng),
      radiusMeters,
      angle
    );
    path.push({ lat: p.lat(), lng: p.lng() });
  }
  return path;
}

/* ===== 初始化地圖 ===== */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: LUKANG_CENTER,
    zoom: 14
  });

  // 1) 先做「聚光燈挖洞」
  buildSpotlightPolygon();

  // 2) 標記景點
  locations.forEach(loc => {
    loc.marker = new google.maps.Marker({
      position: { lat: loc.lat, lng: loc.lng },
      map,
      title: loc.name
    });
  });

  setStatus("地圖已載入，請選擇是否啟用定位（進入鹿港範圍後才開始計時）");
}

/* ===== 回到鹿港 ===== */
function recenterToLukang() {
  map.setCenter(LUKANG_CENTER);
  map.setZoom(14);
  setStatus("已回到鹿港中心");
}

/* ===== 啟用定位 ===== */
function startGeolocation() {
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;

  if (!navigator.geolocation) {
    alert("你的瀏覽器不支援定位功能");
    setStatus("你的瀏覽器不支援定位功能");
    return;
  }

  setStatus("定位啟用中…（若跳出權限請允許）");

  watchId = navigator.geolocation.watchPosition(
    onLocationUpdate,
    onLocationError,
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

function skipGeolocation() {
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;
  setStatus("已進入僅瀏覽模式（不計時、不追蹤位置）");
}

/* ===== 定位失敗 ===== */
function onLocationError(err) {
  recenterToLukang();
  setStatus("定位失敗，已改為僅瀏覽");
  alert("定位失敗：" + (err?.message || "未知原因"));
}

/* ===== 定位更新 ===== */
function onLocationUpdate(position) {
  const userPos = {
    lat: position.coords.latitude,
    lng: position.coords.longitude
  };

  if (!userMarker) {
    userMarker = new google.maps.Marker({
      position: userPos,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#FF0000",
        fillOpacity: 1,
        strokeWeight: 2
      },
      title: "你的位置"
    });
  } else {
    userMarker.setPosition(userPos);
  }

  // 判斷是否進入鹿港範圍（進入後才開始計時）
  const distToCenter = getDistance(userPos.lat, userPos.lng, LUKANG_CENTER.lat, LUKANG_CENTER.lng);

  if (!geofenceEntered) {
    if (distToCenter <= LUKANG_RADIUS_M) {
      geofenceEntered = true;
      startTimer();
      setStatus("已進入鹿港範圍（開始計時）");
      map.setCenter(userPos);
      map.setZoom(17);
    } else {
      setStatus(`定位中：尚未進入鹿港範圍（距中心約 ${Math.round(distToCenter)} 公尺）`);
    }
  } else {
    // 進入後才開始檢查景點完成
    checkProximity(userPos);
  }
}

/* ===== 檢查到達景點（僅在進入鹿港後才運作）===== */
function checkProximity(userPos) {
  locations.forEach(loc => {
    if (!remainingLocations.has(loc.name)) return;

    const distance = getDistance(userPos.lat, userPos.lng, loc.lat, loc.lng);
    if (distance <= 5) {
      loc.marker.setMap(null);
      remainingLocations.delete(loc.name);

      if (remainingLocations.size === 0) {
        stopTimer();
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        alert("所有景點完成！總花費時間：" + document.getElementById("timer").textContent);
        setStatus("所有景點完成！");
      }
    }
  });
}

/* ===== Haversine 距離 ===== */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) ** 2
          + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180)
          * Math.sin(dLon/2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== 計時器 ===== */
function startTimer() {
  if (startTime) return;
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const diff = Date.now() - startTime;
    document.getElementById("timer").textContent = formatTime(diff);
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function formatTime(ms) {
  let sec = Math.floor(ms / 1000);
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  sec %= 3600;
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

window.onload = initMap;
</script>
</body>
</html>



