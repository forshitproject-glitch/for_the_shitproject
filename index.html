<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é¹¿æ¸¯æ™¯é»è¨ˆæ™‚åœ°åœ–</title>

<style>
html, body { height:100%; margin:0; }
#app { height:100%; display:flex; flex-direction:column; }

#uiBar{
  padding:10px 12px;
  background:#fff;
  box-shadow:0 2px 10px rgba(0,0,0,.25);
  display:flex;
  align-items:center;
  gap:12px;
  z-index:10;
}
#map{ flex:1; }

button{
  padding:6px 12px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
.start{ background:#2e7d32; color:#fff; }
.skip{ background:#ccc; }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE"></script>
</head>

<body>
<div id="app">
  <div id="uiBar">
    <button class="start" onclick="startGeolocation()">å•Ÿç”¨å®šä½</button>
    <button class="skip" onclick="skipGeolocation()">ä¸å•Ÿç”¨</button>
    <div>æ™‚é–“ï¼š<span id="timer">00:00:00</span></div>
    <div id="status">ç‹€æ…‹ï¼šç­‰å¾…ä¸­</div>
  </div>
  <div id="map"></div>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const LUKANG_CENTER = { lat:24.056348, lng:120.432589 };
const LUKANG_RADIUS = 4200; // å…¬å°º

const locations = [
  { name:"é¹¿æ¸¯è€è¡—", lat:24.056348, lng:120.432589 },
  { name:"é¹¿æ¸¯é¾å±±å¯º", lat:24.0504, lng:120.4349 },
  { name:"é¹¿æ¸¯å¤©åå®®", lat:24.059338, lng:120.43138 },
  { name:"ç»ç’ƒåª½ç¥–å»Ÿ", lat:24.069118, lng:120.394715 },
  { name:"æ¡‚èŠ±å··è—è¡“æ‘", lat:24.055848, lng:120.431928 },
  { name:"è‡ºç£ç»ç’ƒé¤¨", lat:24.06897, lng:120.394912 },
  { name:"é¹¿æ¸¯æ°‘ä¿—æ–‡ç‰©é¤¨", lat:24.0542, lng:120.436306 },
  { name:"ä¹æ›²å··", lat:24.0535, lng:120.435 },
  { name:"åå®œæ¨“", lat:24.0535, lng:120.4353 },
  { name:"é¹¿æ¸¯æ„æ¨“", lat:24.0529, lng:120.4353 },
  { name:"æ‘¸ä¹³å··", lat:24.051817, lng:120.432231 }
];

let map, userMarker, watchId;
let startTime, timerId;
let entered = false;

/* ===== å·¥å…·ï¼šç®—åœ“ ===== */
function makeCircle(center, radius, points=240){
  const R = 6378137;
  const lat0 = center.lat * Math.PI/180;
  const lng0 = center.lng * Math.PI/180;
  const d = radius / R;
  const res = [];

  for(let i=0;i<=points;i++){
    const b = 2*Math.PI*i/points;
    const lat = Math.asin(
      Math.sin(lat0)*Math.cos(d) +
      Math.cos(lat0)*Math.sin(d)*Math.cos(b)
    );
    const lng = lng0 + Math.atan2(
      Math.sin(b)*Math.sin(d)*Math.cos(lat0),
      Math.cos(d)-Math.sin(lat0)*Math.sin(lat)
    );
    res.push({ lat:lat*180/Math.PI, lng:lng*180/Math.PI });
  }
  return res;
}

/* ===== å»ºç«‹ç¡¬åˆ‡é®ç½© ===== */
function buildMask(){
  const outer = [
    {lat:30,lng:110},{lat:30,lng:130},
    {lat:18,lng:130},{lat:18,lng:110}
  ];
  const hole = makeCircle(LUKANG_CENTER, LUKANG_RADIUS).reverse();

  new google.maps.Polygon({
    map,
    paths:[outer, hole],
    fillColor:"#000",
    fillOpacity:0.75,   // ğŸ”¥ å¤–é¢éå¸¸æš—
    strokeOpacity:0,
    clickable:false
  });
}

/* ===== åœ°åœ–åˆå§‹åŒ– ===== */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:LUKANG_CENTER,
    zoom:12
  });

  locations.forEach(l=>{
    l.marker = new google.maps.Marker({
      map,
      position:{lat:l.lat,lng:l.lng},
      title:l.name
    });
  });

  buildMask();
  setStatus("é€²å…¥é¹¿æ¸¯å¾Œé–‹å§‹è¨ˆæ™‚");
}

/* ===== å®šä½ ===== */
function startGeolocation(){
  navigator.geolocation.watchPosition(onPos);
}
function skipGeolocation(){
  setStatus("åƒ…ç€è¦½æ¨¡å¼");
}

function onPos(pos){
  const p = {lat:pos.coords.latitude, lng:pos.coords.longitude};
  if(!userMarker){
    userMarker = new google.maps.Marker({
      map,
      position:p,
      icon:{
        path:google.maps.SymbolPath.CIRCLE,
        scale:7,
        fillColor:"#f00",
        fillOpacity:1,
        strokeWeight:2
      }
    });
  }else userMarker.setPosition(p);

  const d = distance(p, LUKANG_CENTER);
  if(!entered && d<=LUKANG_RADIUS){
    entered=true;
    startTimer();
    map.setCenter(p);
    map.setZoom(16);
    setStatus("å·²é€²å…¥é¹¿æ¸¯ï¼ˆé–‹å§‹è¨ˆæ™‚ï¼‰");
  }
}

/* ===== è¨ˆæ™‚ ===== */
function startTimer(){
  startTime=Date.now();
  timerId=setInterval(()=>{
    document.getElementById("timer").textContent=format(Date.now()-startTime);
  },1000);
}

function format(ms){
  let s=Math.floor(ms/1000);
  const h=String(Math.floor(s/3600)).padStart(2,"0");
  s%=3600;
  const m=String(Math.floor(s/60)).padStart(2,"0");
  const ss=String(s%60).padStart(2,"0");
  return `${h}:${m}:${ss}`;
}

/* ===== å…¶ä»– ===== */
function setStatus(t){
  document.getElementById("status").textContent="ç‹€æ…‹ï¼š"+t;
}
function distance(a,b){
  const R=6371000;
  const dLat=(b.lat-a.lat)*Math.PI/180;
  const dLng=(b.lng-a.lng)*Math.PI/180;
  const x=Math.sin(dLat/2)**2+
    Math.cos(a.lat*Math.PI/180)*Math.cos(b.lat*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}

window.onload=initMap;
</script>
</body>
</html>
