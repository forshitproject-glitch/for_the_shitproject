<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é¹¿æ¸¯æ™¯é»è¨ˆæ™‚åœ°åœ–</title>

<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #app { height: 100%; display: flex; flex-direction: column; }

  /* ä¸Šæ–¹ UI */
  #uiBar{
    flex: 0 0 auto;
    padding: 10px 12px;
    background: rgba(255,255,255,0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    z-index: 10;
  }
  #uiBar .title { font-weight: 700; font-size: 16px; }

  #timerBox {
    font-weight: 700;
    font-size: 16px;
    padding: 6px 10px;
    border-radius: 10px;
    background: #f5f5f5;
  }
  #statusBox { font-size: 14px; color: #333; }

  #uiBar button{
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }
  .start-btn { background:#2e7d32; color:#fff; }
  .cancel-btn { background:#e0e0e0; }
  .reset-btn { background:#1565c0; color:#fff; }

  #map { flex: 1 1 auto; width: 100%; }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE"></script>
</head>

<body>
<div id="app">
  <div id="uiBar">
    <div class="title">é¹¿æ¸¯å®šä½è¨ˆæ™‚</div>
    <button class="start-btn" id="btnStart" onclick="startGeolocation()">å•Ÿç”¨å®šä½</button>
    <button class="cancel-btn" id="btnSkip" onclick="skipGeolocation()">ä¸å•Ÿç”¨</button>
    <button class="reset-btn" onclick="recenterToLukang()">å›åˆ°é¹¿æ¸¯</button>

    <div id="timerBox">å·²èŠ±è²»æ™‚é–“ï¼š<span id="timer">00:00:00</span></div>
    <div id="statusBox">ç‹€æ…‹ï¼šå°šæœªé–‹å§‹</div>
  </div>

  <div id="map"></div>
</div>

<script>
/* =====================
   é¹¿æ¸¯è¨­å®š
   ===================== */
const LUKANG_CENTER = { lat: 24.056348, lng: 120.432589 };
const LUKANG_RADIUS_M = 4200;

/* =====================
   æ™¯é»è³‡æ–™ï¼ˆ12 å€‹ï¼‰
   ===================== */
const locations = [
  { name: "ç»ç’ƒé¤¨", lat: 24.068667, lng: 120.395437 },
  { name: "é¹¿æ¸¯è€è¡—", lat: 24.056348, lng: 120.432589 },
  { name: "é¹¿æ¸¯é¾å±±å¯º", lat: 24.0504, lng: 120.4349 },
  { name: "é¹¿æ¸¯å¤©åå®®", lat: 24.059338, lng: 120.43138 },
  { name: "ç»ç’ƒåª½ç¥–å»Ÿ", lat: 24.069118, lng: 120.394715 },
  { name: "æ¡‚èŠ±å··è—è¡“æ‘", lat: 24.055848, lng: 120.431928 },
  { name: "è‡ºç£ç»ç’ƒé¤¨", lat: 24.06897, lng: 120.394912 },
  { name: "é¹¿æ¸¯æ°‘ä¿—æ–‡ç‰©é¤¨", lat: 24.0542, lng: 120.436306 },
  { name: "ä¹æ›²å··", lat: 24.0535, lng: 120.435 },
  { name: "åå®œæ¨“", lat: 24.0535, lng: 120.4353 },
  { name: "é¹¿æ¸¯æ„æ¨“", lat: 24.0529, lng: 120.4353 },
  { name: "æ‘¸ä¹³å··", lat: 24.051817, lng: 120.432231 }
];

let map;
let userMarker = null;
let watchId = null;

let startTime = null;
let timerInterval = null;
let geofenceEntered = false;
let remaining = new Set(locations.map(l => l.name));

/* =====================
   å·¥å…·
   ===================== */
function setStatus(msg){
  document.getElementById("statusBox").textContent = "ç‹€æ…‹ï¼š" + msg;
}

function formatTime(ms){
  let s = Math.floor(ms / 1000);
  const h = String(Math.floor(s / 3600)).padStart(2,"0");
  s %= 3600;
  const m = String(Math.floor(s / 60)).padStart(2,"0");
  const ss = String(s % 60).padStart(2,"0");
  return `${h}:${m}:${ss}`;
}

function getDistance(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* =====================
   åœ“å½¢ pathï¼ˆä¸é  geometryï¼‰
   ===================== */
function makeCirclePath(center, radius, points=240){
  const R = 6378137;
  const lat0 = center.lat * Math.PI/180;
  const lng0 = center.lng * Math.PI/180;
  const d = radius / R;
  const path = [];

  for(let i=0;i<points;i++){
    const b = 2*Math.PI*i/points;
    const lat = Math.asin(
      Math.sin(lat0)*Math.cos(d) +
      Math.cos(lat0)*Math.sin(d)*Math.cos(b)
    );
    const lng = lng0 + Math.atan2(
      Math.sin(b)*Math.sin(d)*Math.cos(lat0),
      Math.cos(d)-Math.sin(lat0)*Math.sin(lat)
    );
    path.push({ lat: lat*180/Math.PI, lng: lng*180/Math.PI });
  }
  return path;
}

/* =====================
   â­ èšå…‰é®ç½©ï¼ˆé‡é»ä¿®æ”¹ï¼‰
   ===================== */
function buildSpotlight(){
  const outer = [
    { lat: 27.8, lng: 117.5 },
    { lat: 27.8, lng: 124.8 },
    { lat: 20.0, lng: 124.8 },
    { lat: 20.0, lng: 117.5 }
  ];

  const holeFar   = makeCirclePath(LUKANG_CENTER, 6000).reverse();
  const holeMid   = makeCirclePath(LUKANG_CENTER, 4800).reverse();
  const holeInner = makeCirclePath(LUKANG_CENTER, 4200).reverse();

  new google.maps.Polygon({
    map,
    paths:[outer, holeFar],
    fillColor:"#000",
    fillOpacity:0.75,
    strokeOpacity:0,
    clickable:false
  });

  new google.maps.Polygon({
    map,
    paths:[outer, holeMid],
    fillColor:"#000",
    fillOpacity:0.45,
    strokeOpacity:0,
    clickable:false
  });

  new google.maps.Polygon({
    map,
    paths:[outer, holeInner],
    fillColor:"#000",
    fillOpacity:0.10,
    strokeOpacity:0,
    clickable:false
  });
}

/* =====================
   åœ°åœ–åˆå§‹åŒ–
   ===================== */
function initMap(){
  map = new google.maps.Map(document.getElementById("map"),{
    center:LUKANG_CENTER,
    zoom:12
  });

  locations.forEach(loc=>{
    loc.marker = new google.maps.Marker({
      position:{lat:loc.lat,lng:loc.lng},
      map,
      title:loc.name
    });
  });

  buildSpotlight();
  setStatus("é€²å…¥é¹¿æ¸¯ç¯„åœå¾Œé–‹å§‹è¨ˆæ™‚");
}

/* =====================
   æ“ä½œ
   ===================== */
function recenterToLukang(){
  map.setCenter(LUKANG_CENTER);
  map.setZoom(12);
}

function startGeolocation(){
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;
  watchId = navigator.geolocation.watchPosition(onLocation);
}

function skipGeolocation(){
  setStatus("æœªå•Ÿç”¨å®šä½ï¼ˆåƒ…ç€è¦½ï¼‰");
}

function onLocation(pos){
  const p = { lat:pos.coords.latitude, lng:pos.coords.longitude };

  if(!userMarker){
    userMarker = new google.maps.Marker({
      position:p,
      map,
      icon:{
        path:google.maps.SymbolPath.CIRCLE,
        scale:8,
        fillColor:"#ff0000",
        fillOpacity:1,
        strokeWeight:2
      }
    });
  } else {
    userMarker.setPosition(p);
  }

  const d = getDistance(p.lat,p.lng,LUKANG_CENTER.lat,LUKANG_CENTER.lng);

  if(!geofenceEntered && d<=LUKANG_RADIUS_M){
    geofenceEntered = true;
    startTime = Date.now();
    timerInterval = setInterval(()=>{
      document.getElementById("timer").textContent =
        formatTime(Date.now()-startTime);
    },1000);

    setStatus("å·²é€²å…¥é¹¿æ¸¯ï¼ˆé–‹å§‹è¨ˆæ™‚ï¼‰");
    map.setCenter(p);
    map.setZoom(16);
  }

  if(geofenceEntered){
    locations.forEach(loc=>{
      if(!remaining.has(loc.name)) return;
      if(getDistance(p.lat,p.lng,loc.lat,loc.lng)<=5){
        loc.marker.setMap(null);
        remaining.delete(loc.name);
        if(remaining.size===0){
          clearInterval(timerInterval);
          setStatus("ğŸ‰ å…¨éƒ¨æ™¯é»å®Œæˆï¼");
        }
      }
    });
  }
}

window.onload = initMap;
</script>
</body>
</html>
