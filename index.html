<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é¹¿æ¸¯æ™¯é»å°è¦½åœ°åœ–</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE&libraries=geometry"></script>

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { width: 100%; height: 540px; }
    .ctrl { padding: 10px; }
    button { margin-right: 10px; }
  </style>
</head>

<body>
<div id="app">
  <div class="ctrl">
    <button @click="startTracking">é–‹å§‹å®šä½è¿½è¹¤</button>
    <button @click="stopTracking" :disabled="!watchId">åœæ­¢å®šä½è¿½è¹¤</button>
    <span v-if="lastStatus">ï½œ {{ lastStatus }}</span>
  </div>
  <div id="map"></div>
</div>

<script>
const googleMap = new Vue({
  el: "#app",
  data: {
    map: null,
    watchId: null,
    userMarker: null,
    accuracyCircle: null,
    lastStatus: "",
    arrivalThreshold: 5, // 5 å…¬å°ºç¯„åœå³è¦–ç‚ºæŠµé”æ™¯é»
    insideStartTime: null,
    totalStaySeconds: 0,
    lukangPolygon: null,

    // ğŸ æ™¯é»è³‡æ–™ï¼ˆ11 å€‹ï¼‰
    spots: [
      { id: "glass", name: "ç»ç’ƒé¤¨", lat: 24.068667, lng: 120.395437 },
      { id: "oldstreet", name: "é¹¿æ¸¯è€è¡—", lat: 24.056348, lng: 120.432589 },
      { id: "longshan", name: "é¹¿æ¸¯é¾å±±å¯º", lat: 24.0504, lng: 120.4349 },
      { id: "matsu", name: "é¹¿æ¸¯å¤©åå®®", lat: 24.059338, lng: 120.431380 },
      { id: "glassmatsu", name: "ç»ç’ƒåª½ç¥–å»Ÿ", lat: 24.069118, lng: 120.394715 },
      { id: "osmanthus", name: "æ¡‚èŠ±å··è—è¡“æ‘", lat: 24.055848, lng: 120.431928 },
      { id: "twglass", name: "è‡ºç£ç»ç’ƒé¤¨", lat: 24.068970, lng: 120.394912 },
      { id: "museum", name: "é¹¿æ¸¯åæ°‘ä¿—æ–‡ç‰©é¤¨", lat: 24.054200, lng: 120.436306 },
      { id: "jiuqu", name: "ä¹æ›²å··", lat: 24.0535, lng: 120.4350 },
      { id: "shiyi", name: "åå®œæ¨“", lat: 24.0535, lng: 120.4353 },
      { id: "moru", name: "æ‘¸ä¹³å··", lat: 24.051817, lng: 120.432231 }
    ],

    spotMarkers: new Map()
  },

  methods: {
    initMap() {
      const lukang = { lat: 24.0565, lng: 120.4351 };
      const taiwanCenter = { lat: 23.7, lng: 121 };

      // åœ°åœ–åˆå§‹åŒ–
      this.map = new google.maps.Map(document.getElementById("map"), {
        center: lukang,
        zoom: 7,
        mapTypeId: "roadmap",
      });

      // å·¥å…·ï¼šç”¢ç”Ÿåœ“å½¢ Polygon é»
      const createCirclePath = (center, radius, points = 128) => {
        const arr = [];
        const R = 6378137;
        const lat = center.lat * Math.PI/180;
        const lng = center.lng * Math.PI/180;
        const d = radius / R;

        for (let i = 0; i <= points; i++) {
          const a = (i * 2 * Math.PI) / points;
          const latP = Math.asin(Math.sin(lat) * Math.cos(d) + Math.cos(lat) * Math.sin(d) * Math.cos(a));
          const lngP = lng + Math.atan2(
            Math.sin(a) * Math.sin(d) * Math.cos(lat),
            Math.cos(d) - Math.sin(lat) * Math.sin(latP)
          );
          arr.push({ lat: latP * 180 / Math.PI, lng: lngP * 180 / Math.PI });
        }
        return arr;
      };

      // é®ç½©ï¼šå°ç£æš—ã€é¹¿æ¸¯äº®æ´å£
      const taiwanCircle = createCirclePath(taiwanCenter, 350000);
      const lukangHole = createCirclePath(lukang, 6000).reverse();

      this.lukangPolygon = new google.maps.Polygon({
        paths: [taiwanCircle, lukangHole],
        strokeColor: "transparent",
        strokeOpacity: 0,
        fillColor: "black",
        fillOpacity: 0.5,
        clickable: false,
        map: this.map
      });

      // é©ç•¶ç¸®æ”¾
      const bounds = new google.maps.LatLngBounds();
      lukangHole.forEach(p => bounds.extend(p));
      this.map.fitBounds(bounds, 80);
      this.map.setOptions({ maxZoom: 17 });

      // æ”¾æ™¯é»
      this.renderSpots();

      // ä½¿ç”¨è€…æ¨™è¨˜ï¼ˆèµ·å§‹éš±è—ï¼‰
      this.userMarker = new google.maps.Marker({
        map: this.map,
        visible: false,
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 7,
          fillColor: "red",
          fillOpacity: 1,
          strokeColor: "white",
          strokeWeight: 2
        }
      });

      this.accuracyCircle = new google.maps.Circle({
        map: this.map,
        fillColor: "#4285F4",
        fillOpacity: 0.15,
        strokeOpacity: 0,
        visible: false
      });
    },

    renderSpots() {
      this.spots.forEach(s => {
        const m = new google.maps.Marker({
          position: { lat: s.lat, lng: s.lng },
          map: this.map,
          title: s.name
        });
        this.spotMarkers.set(s.id, m);
      });
    },

    startTracking() {
      if (!navigator.geolocation) {
        this.lastStatus = "ç€è¦½å™¨ä¸æ”¯æ´å®šä½";
        return;
      }

      this.watchId = navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          const point = new google.maps.LatLng(latitude, longitude);

          // é¡¯ç¤ºä½¿ç”¨è€…ä½ç½®èˆ‡ç²¾åº¦
          this.userMarker.setPosition(point);
          this.userMarker.setVisible(true);
          this.accuracyCircle.setCenter(point);
          this.accuracyCircle.setRadius(accuracy || 50);
          this.accuracyCircle.setVisible(true);

          // é€²å…¥é¹¿æ¸¯åœˆ â†’ è¨ˆæ™‚é–‹å§‹
          const inside = google.maps.geometry.poly.containsLocation(
            point,
            this.lukangPolygon
          );

          if (inside && !this.insideStartTime) {
            this.insideStartTime = Date.now();
          }

          if (!inside && this.insideStartTime) {
            this.totalStaySeconds += (Date.now() - this.insideStartTime) / 1000;
            this.insideStartTime = null;
          }

          // è‡ªå‹•ç¸®æ”¾åˆ°ä½¿ç”¨è€… 100m
          this.map.setCenter(point);
          this.map.setZoom(18);

          // æª¢æŸ¥æ™¯é»
          this.checkArrivals(point);

          this.lastStatus = `å®šä½æˆåŠŸï¼ˆÂ±${Math.round(accuracy)}mï¼‰`;
        },

        err => {
          this.lastStatus = "æœªé–‹å•Ÿå®šä½ â†’ é¡¯ç¤ºé¹¿æ¸¯";
          this.map.setCenter({ lat: 24.0565, lng: 120.4351 });
          this.map.setZoom(15);
        },

        { enableHighAccuracy: true, timeout: 15000 }
      );
    },

    stopTracking() {
      if (this.watchId) {
        navigator.geolocation.clearWatch(this.watchId);
        this.watchId = null;
        this.lastStatus = "å·²åœæ­¢è¿½è¹¤";
      }
    },

    checkArrivals(userLoc) {
      for (const [id, marker] of this.spotMarkers.entries()) {
        const dist = google.maps.geometry.spherical.computeDistanceBetween(
          userLoc,
          marker.getPosition()
        );

        if (dist <= this.arrivalThreshold) {
          marker.setMap(null);
          this.spotMarkers.delete(id);

          this.lastStatus = `åˆ°é”ã€Œ${marker.getTitle()}ã€`;

          // å…¨éƒ¨æ™¯é»å®Œæˆ â†’ åœæ­¢ç¸½è¨ˆæ™‚
          if (this.spotMarkers.size === 0) {
            if (this.insideStartTime) {
              this.totalStaySeconds += (Date.now() - this.insideStartTime) / 1000;
              this.insideStartTime = null;
            }

            const m = Math.floor(this.totalStaySeconds / 60);
            const s = Math.floor(this.totalStaySeconds % 60);

            alert(`ğŸ‰ å…¨éƒ¨æ™¯é»å®Œæˆï¼\nç¸½åœç•™æ™‚é–“ï¼š${m} åˆ† ${s} ç§’`);
          }
        }
      }
    }
  },

  mounted() {
    const boot = () => this.initMap();
    if (window.google && google.maps) boot();
    else {
      const t = setInterval(() => {
        if (window.google && google.maps) { clearInterval(t); boot(); }
      }, 200);
    }
  }
});
</script>
</body>
</html>
