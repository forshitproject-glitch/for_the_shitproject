<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>鹿港景點計時地圖</title>

<style>
  html, body { height: 100%; margin: 0; padding: 0; }

  /* 用 flex 把 UI 與地圖分開：上面 UI、下面地圖 */
  #app {
    height: 100%;
    display: flex;
    flex-direction: column;
  }

  /* 上方 UI 區（不覆蓋地圖） */
  #uiBar {
    flex: 0 0 auto;
    padding: 10px 12px;
    background: rgba(255,255,255,0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
    z-index: 1;
  }

  #uiBar .title {
    font-weight: 700;
    font-size: 16px;
    margin-right: 6px;
  }

  #timerBox {
    font-weight: 700;
    font-size: 16px;
    padding: 6px 10px;
    border-radius: 10px;
    background: rgba(245,245,245,1);
  }

  #statusBox {
    font-size: 14px;
    color: #333;
  }

  #uiBar button {
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
  }

  .start-btn { background: #2e7d32; color: #fff; }
  .cancel-btn { background: #e0e0e0; }
  .reset-btn { background: #1565c0; color: #fff; }

  /* 地圖區 */
  #map {
    flex: 1 1 auto;
    width: 100%;
  }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE"></script>
</head>

<body>
<div id="app">
  <!-- UI 不覆蓋地圖，永遠看得到 -->
  <div id="uiBar">
    <div class="title">定位與計時</div>

    <button class="start-btn" id="btnStart" onclick="startGeolocation()">啟用定位</button>
    <button class="cancel-btn" id="btnSkip" onclick="skipGeolocation()">不啟用</button>
    <button class="reset-btn" onclick="recenterToLukang()">回到鹿港</button>

    <div id="timerBox">已花費時間：<span id="timer">00:00:00</span></div>
    <div id="statusBox">狀態：尚未選擇定位模式</div>
  </div>

  <div id="map"></div>
</div>

<script>
/* ===== 基本設定（鹿港中心 & 光圈）===== */
const LUKANG_CENTER = { lat: 24.056348, lng: 120.432589 }; // 鹿港老街附近
const LUKANG_CIRCLE_RADIUS_M = 900; // 光圈半徑（公尺）你可調：500/800/1200...

/* ===== 景點資料 ===== */
const locations = [
  { name: "玻璃館", lat: 24.068667, lng: 120.395437 },
  { name: "鹿港老街", lat: 24.056348, lng: 120.432589 },
  { name: "鹿港龍山寺", lat: 24.0504, lng: 120.4349 },
  { name: "鹿港天后宮", lat: 24.059338, lng: 120.431380 },
  { name: "玻璃媽祖廟", lat: 24.069118, lng: 120.394715 },
  { name: "桂花巷藝術村", lat: 24.055848, lng: 120.431928 },
  { name: "臺灣玻璃館", lat: 24.068970, lng: 120.394912 },
  { name: "鹿港民俗文物館", lat: 24.054200, lng: 120.436306 },
  { name: "九曲巷", lat: 24.0535, lng: 120.4350 },
  { name: "十宜樓", lat: 24.0535, lng: 120.4353 },
  { name: "鹿港意樓", lat: 24.0529, lng: 120.4353 },
  { name: "摸乳巷", lat: 24.051817, lng: 120.432231 }
];

let map;
let lukangCircle = null;     // 鹿港光圈（你說的那個）
let userMarker = null;       // 使用者位置點
let watchId = null;          // watchPosition id

let startTime = null;
let timerInterval = null;
let remainingLocations = new Set(locations.map(loc => loc.name));

function setStatus(msg) {
  document.getElementById("statusBox").textContent = "狀態：" + msg;
}

/* ===== 初始化地圖 ===== */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: LUKANG_CENTER,
    zoom: 15,
    disableDefaultUI: false
  });

  // 1) 加回「鹿港光圈」
  lukangCircle = new google.maps.Circle({
    map,
    center: LUKANG_CENTER,
    radius: LUKANG_CIRCLE_RADIUS_M,
    strokeOpacity: 0.7,
    strokeWeight: 2,
    fillOpacity: 0.18
  });

  // 2) 標記景點
  locations.forEach(loc => {
    loc.marker = new google.maps.Marker({
      position: { lat: loc.lat, lng: loc.lng },
      map,
      title: loc.name
    });
  });

  setStatus("地圖已載入，請選擇是否啟用定位");
}

/* ===== UI：回到鹿港 ===== */
function recenterToLukang() {
  map.setCenter(LUKANG_CENTER);
  map.setZoom(15);
  setStatus("已回到鹿港中心");
}

/* ===== 使用者選擇啟用定位 ===== */
function startGeolocation() {
  // UI 按鈕避免重複點
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;

  if (!navigator.geolocation) {
    setStatus("你的瀏覽器不支援定位功能");
    alert("你的瀏覽器不支援定位功能");
    return;
  }

  setStatus("正在啟用定位中…（若跳出權限請允許）");

  watchId = navigator.geolocation.watchPosition(
    onLocationUpdate,
    onLocationError,
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 10000
    }
  );
}

/* ===== 使用者選擇不啟用定位 ===== */
function skipGeolocation() {
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;

  setStatus("已進入僅瀏覽模式（不計時、不追蹤位置）");
}

/* ===== 定位失敗 ===== */
function onLocationError(err) {
  // 不要整個卡死，回到鹿港
  recenterToLukang();
  setStatus("定位失敗，已改為僅瀏覽（可按回到鹿港）");
  alert("定位失敗：" + (err?.message || "未知原因") + "。將顯示鹿港地圖。");
}

/* ===== 定位更新 ===== */
function onLocationUpdate(position) {
  const userPos = {
    lat: position.coords.latitude,
    lng: position.coords.longitude
  };

  if (!userMarker) {
    // 第一次定位成功才開始計時
    userMarker = new google.maps.Marker({
      position: userPos,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#FF0000",
        fillOpacity: 1,
        strokeWeight: 2
      },
      title: "你的位置"
    });

    map.setCenter(userPos);
    map.setZoom(18);

    startTimer();
    setStatus("定位中（已開始計時）");
  } else {
    userMarker.setPosition(userPos);
  }

  checkProximity(userPos);
}

/* ===== 檢查到達景點 ===== */
function checkProximity(userPos) {
  locations.forEach(loc => {
    if (!remainingLocations.has(loc.name)) return;

    const distance = getDistance(userPos.lat, userPos.lng, loc.lat, loc.lng);
    if (distance <= 5) {
      loc.marker.setMap(null);
      remainingLocations.delete(loc.name);

      if (remainingLocations.size === 0) {
        stopTimer();
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        alert("所有景點完成！總花費時間：" + document.getElementById("timer").textContent);
        setStatus("所有景點完成！");
      }
    }
  });
}

/* ===== 計算距離（Haversine）===== */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) ** 2
          + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180)
          * Math.sin(dLon/2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== 計時器 ===== */
function startTimer() {
  if (startTime) return;
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const diff = Date.now() - startTime;
    document.getElementById("timer").textContent = formatTime(diff);
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function formatTime(ms) {
  let sec = Math.floor(ms / 1000);
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  sec %= 3600;
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

window.onload = initMap;
</script>
</body>
</html>



