<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>é¹¿æ¸¯æ™¯é»è¨ˆæ™‚åœ°åœ–</title>

<style>
  html, body { height: 100%; margin: 0; padding: 0; }
  #app { height: 100%; display: flex; flex-direction: column; }

  /* ä¸Šæ–¹ UIï¼ˆä¸è¦†è“‹åœ°åœ–ï¼‰ */
  #uiBar{
    flex: 0 0 auto;
    padding: 10px 12px;
    background: rgba(255,255,255,0.98);
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 10px;
  }
  #uiBar .title { font-weight: 700; font-size: 16px; }

  #timerBox {
    font-weight: 700; font-size: 16px;
    padding: 6px 10px; border-radius: 10px;
    background: rgba(245,245,245,1);
  }
  #statusBox { font-size: 14px; color: #333; }

  #uiBar button{
    font-size: 14px; padding: 8px 12px;
    border-radius: 10px; border: none; cursor: pointer;
  }
  .start-btn { background:#2e7d32; color:#fff; }
  .cancel-btn { background:#e0e0e0; }
  .reset-btn { background:#1565c0; color:#fff; }

  #map { flex: 1 1 auto; width: 100%; }
</style>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC9yd5GeV-J0SHVtpkeHvtFfSryaavAKIE"></script>
</head>

<body>
<div id="app">
  <div id="uiBar">
    <div class="title">å®šä½èˆ‡è¨ˆæ™‚</div>
    <button class="start-btn" id="btnStart" onclick="startGeolocation()">å•Ÿç”¨å®šä½</button>
    <button class="cancel-btn" id="btnSkip" onclick="skipGeolocation()">ä¸å•Ÿç”¨</button>
    <button class="reset-btn" onclick="recenterToLukang()">å›åˆ°é¹¿æ¸¯</button>

    <div id="timerBox">å·²èŠ±è²»æ™‚é–“ï¼š<span id="timer">00:00:00</span></div>
    <div id="statusBox">ç‹€æ…‹ï¼šå°šæœªé¸æ“‡å®šä½æ¨¡å¼</div>
  </div>

  <div id="map"></div>
</div>

<script>
/* =========================
   1) é¹¿æ¸¯ç¯„åœè¨­å®šï¼ˆå¯èª¿ï¼‰
   ========================= */
const LUKANG_CENTER = { lat: 24.056348, lng: 120.432589 }; // é¹¿æ¸¯è€è¡—é™„è¿‘
const LUKANG_RADIUS_M = 3200;  // âœ… åŒ…ä½æ•´å€‹é¹¿æ¸¯ï¼šå»ºè­° 3000~3500
const DIM_OPACITY = 0.22;      // âœ… è®Šæš—ç¨‹åº¦ï¼šè¶Šå°è¶Šäº®ï¼ˆ0.18~0.25 å¥½çœ‹ï¼‰

/* =========================
   2) æ™¯é»è³‡æ–™
   ========================= */
const locations = [
  { name: "ç»ç’ƒé¤¨", lat: 24.068667, lng: 120.395437 },
  { name: "é¹¿æ¸¯è€è¡—", lat: 24.056348, lng: 120.432589 },
  { name: "é¹¿æ¸¯é¾å±±å¯º", lat: 24.0504, lng: 120.4349 },
  { name: "é¹¿æ¸¯å¤©åå®®", lat: 24.059338, lng: 120.431380 },
  { name: "ç»ç’ƒåª½ç¥–å»Ÿ", lat: 24.069118, lng: 120.394715 },
  { name: "æ¡‚èŠ±å··è—è¡“æ‘", lat: 24.055848, lng: 120.431928 },
  { name: "è‡ºç£ç»ç’ƒé¤¨", lat: 24.068970, lng: 120.394912 },
  { name: "é¹¿æ¸¯æ°‘ä¿—æ–‡ç‰©é¤¨", lat: 24.054200, lng: 120.436306 },
  { name: "ä¹æ›²å··", lat: 24.0535, lng: 120.4350 },
  { name: "åå®œæ¨“", lat: 24.0535, lng: 120.4353 },
  { name: "é¹¿æ¸¯æ„æ¨“", lat: 24.0529, lng: 120.4353 },
  { name: "æ‘¸ä¹³å··", lat: 24.051817, lng: 120.432231 }
];

/* =========================
   3) å…¨åŸŸè®Šæ•¸
   ========================= */
let map;
let lukangCircle = null;       // é¹¿æ¸¯ç¯„åœåœˆï¼ˆè¦–è¦ºè¼”åŠ©ï¼‰
let spotlightPolygon = null;   // å…¨å€è®Šæš— + é¹¿æ¸¯æŒ–æ´
let userMarker = null;
let watchId = null;

let startTime = null;
let timerInterval = null;
let geofenceEntered = false;
let remainingLocations = new Set(locations.map(l => l.name));

/* =========================
   4) UI helper
   ========================= */
function setStatus(msg) {
  document.getElementById("statusBox").textContent = "ç‹€æ…‹ï¼š" + msg;
}

/* =========================
   5) ç”¢ç”Ÿè¿‘ä¼¼åœ“æ´ï¼ˆä¸éœ€è¦ geometryï¼‰
   ========================= */
function makeCirclePathApprox(center, radiusMeters, points = 180) {
  const R = 6378137; // WGS84 åœ°çƒåŠå¾‘
  const lat0 = center.lat * Math.PI / 180;
  const lng0 = center.lng * Math.PI / 180;
  const d = radiusMeters / R;

  const path = [];
  for (let i = 0; i < points; i++) {
    const brng = (2 * Math.PI * i) / points;

    const lat = Math.asin(
      Math.sin(lat0) * Math.cos(d) +
      Math.cos(lat0) * Math.sin(d) * Math.cos(brng)
    );

    const lng = lng0 + Math.atan2(
      Math.sin(brng) * Math.sin(d) * Math.cos(lat0),
      Math.cos(d) - Math.sin(lat0) * Math.sin(lat)
    );

    path.push({ lat: lat * 180 / Math.PI, lng: lng * 180 / Math.PI });
  }
  return path;
}

/* =========================
   6) å…¨å€è®Šæš— + é¹¿æ¸¯æŒ–æ´
   ========================= */
function buildSpotlight() {
  // å¤–åœˆï¼šåŒ…ä½å°ç£é™„è¿‘å³å¯ï¼ˆé¿å…ç”¨å…¨ä¸–ç•Œé€ æˆä½ èªªçš„æ•´å€‹å°ç£éƒ½æ€ªæ€ªçš„ï¼‰
  const outer = [
    { lat: 27.8, lng: 117.5 },
    { lat: 27.8, lng: 124.8 },
    { lat: 20.0, lng: 124.8 },
    { lat: 20.0, lng: 117.5 }
  ];

  // å…§åœˆï¼ˆæ´ï¼‰ï¼šé¹¿æ¸¯åœ“æ´
  const hole = makeCirclePathApprox(LUKANG_CENTER, LUKANG_RADIUS_M, 220);

  spotlightPolygon = new google.maps.Polygon({
    map,
    paths: [outer, hole],
    fillColor: "#000000",
    fillOpacity: DIM_OPACITY, // è¶Šå°è¶Šäº®ï¼ˆè¶Šä¸æš—ï¼‰
    strokeOpacity: 0,
    clickable: false,
    zIndex: 2
  });
}

/* =========================
   7) é¹¿æ¸¯ç¯„åœåœˆï¼ˆä¸€å®šçœ‹å¾—è¦‹ï¼‰
   ========================= */
function buildLukangCircle() {
  lukangCircle = new google.maps.Circle({
    map,
    center: LUKANG_CENTER,
    radius: LUKANG_RADIUS_M,
    strokeColor: "#FF5722",
    strokeOpacity: 1,
    strokeWeight: 4,
    fillColor: "#FF5722",
    fillOpacity: 0.06,
    clickable: false,
    zIndex: 3
  });
}

/* =========================
   8) åˆå§‹åŒ–åœ°åœ–
   ========================= */
function initMap() {
  map = new google.maps.Map(document.getElementById("map"), {
    center: LUKANG_CENTER,
    zoom: 13  // ç¯„åœå¤§ï¼Œzoom 13 æ¯”è¼ƒåƒæ•´å€‹é¹¿æ¸¯
  });

  // æ™¯é» marker
  locations.forEach(loc => {
    loc.marker = new google.maps.Marker({
      position: { lat: loc.lat, lng: loc.lng },
      map,
      title: loc.name
    });
  });

  buildSpotlight();
  buildLukangCircle();

  setStatus("åœ°åœ–å·²è¼‰å…¥ï¼šå•Ÿç”¨å®šä½å¾Œï¼Œé€²å…¥é¹¿æ¸¯ç¯„åœæ‰æœƒé–‹å§‹è¨ˆæ™‚");
}

/* =========================
   9) å›åˆ°é¹¿æ¸¯
   ========================= */
function recenterToLukang() {
  map.setCenter(LUKANG_CENTER);
  map.setZoom(13);
  setStatus("å·²å›åˆ°é¹¿æ¸¯ä¸­å¿ƒ");
}

/* =========================
   10) å•Ÿç”¨/ç•¥éå®šä½
   ========================= */
function startGeolocation() {
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;

  if (!navigator.geolocation) {
    alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
    setStatus("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
    return;
  }

  setStatus("å®šä½å•Ÿç”¨ä¸­â€¦ï¼ˆè‹¥è·³å‡ºæ¬Šé™è«‹å…è¨±ï¼‰");

  watchId = navigator.geolocation.watchPosition(
    onLocationUpdate,
    onLocationError,
    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
  );
}

function skipGeolocation() {
  document.getElementById("btnStart").disabled = true;
  document.getElementById("btnSkip").disabled = true;
  setStatus("å·²é€²å…¥åƒ…ç€è¦½æ¨¡å¼ï¼ˆä¸è¨ˆæ™‚ã€ä¸è¿½è¹¤ä½ç½®ï¼‰");
}

/* =========================
   11) å®šä½å›å‘¼
   ========================= */
function onLocationError(err) {
  recenterToLukang();
  setStatus("å®šä½å¤±æ•—ï¼Œå·²æ”¹ç‚ºåƒ…ç€è¦½");
  alert("å®šä½å¤±æ•—ï¼š" + (err?.message || "æœªçŸ¥åŸå› "));
}

function onLocationUpdate(position) {
  const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };

  if (!userMarker) {
    userMarker = new google.maps.Marker({
      position: userPos,
      map,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 8,
        fillColor: "#FF0000",
        fillOpacity: 1,
        strokeWeight: 2
      },
      title: "ä½ çš„ä½ç½®"
    });
  } else {
    userMarker.setPosition(userPos);
  }

  // é€²å…¥é¹¿æ¸¯ç¯„åœå¾Œæ‰é–‹å§‹è¨ˆæ™‚
  const dist = getDistance(userPos.lat, userPos.lng, LUKANG_CENTER.lat, LUKANG_CENTER.lng);

  if (!geofenceEntered) {
    if (dist <= LUKANG_RADIUS_M) {
      geofenceEntered = true;
      startTimer();
      setStatus("âœ… å·²é€²å…¥é¹¿æ¸¯ç¯„åœï¼ˆé–‹å§‹è¨ˆæ™‚ï¼‰");
      map.setCenter(userPos);
      map.setZoom(16);
    } else {
      setStatus(`å®šä½ä¸­ï¼šå°šæœªé€²å…¥é¹¿æ¸¯ç¯„åœï¼ˆè·ä¸­å¿ƒç´„ ${Math.round(dist)} å…¬å°ºï¼‰`);
    }
  } else {
    checkProximity(userPos);
  }
}

/* =========================
   12) æ™¯é»æ¥è¿‘åˆ¤æ–·
   ========================= */
function checkProximity(userPos) {
  locations.forEach(loc => {
    if (!remainingLocations.has(loc.name)) return;

    const distance = getDistance(userPos.lat, userPos.lng, loc.lat, loc.lng);
    if (distance <= 5) {
      loc.marker.setMap(null);
      remainingLocations.delete(loc.name);

      if (remainingLocations.size === 0) {
        stopTimer();
        if (watchId !== null) navigator.geolocation.clearWatch(watchId);
        alert("æ‰€æœ‰æ™¯é»å®Œæˆï¼ç¸½èŠ±è²»æ™‚é–“ï¼š" + document.getElementById("timer").textContent);
        setStatus("ğŸ‰ æ‰€æœ‰æ™¯é»å®Œæˆï¼");
      }
    }
  });
}

/* =========================
   13) è·é›¢è¨ˆç®—ï¼ˆHaversineï¼‰
   ========================= */
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) ** 2
          + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180)
          * Math.sin(dLon/2) ** 2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* =========================
   14) è¨ˆæ™‚å™¨
   ========================= */
function startTimer() {
  if (startTime) return;
  startTime = Date.now();
  timerInterval = setInterval(() => {
    const diff = Date.now() - startTime;
    document.getElementById("timer").textContent = formatTime(diff);
  }, 1000);
}

function stopTimer() {
  clearInterval(timerInterval);
}

function formatTime(ms) {
  let sec = Math.floor(ms / 1000);
  const h = String(Math.floor(sec / 3600)).padStart(2, "0");
  sec %= 3600;
  const m = String(Math.floor(sec / 60)).padStart(2, "0");
  const s = String(sec % 60).padStart(2, "0");
  return `${h}:${m}:${s}`;
}

window.onload = initMap;
</script>
</body>
</html>



